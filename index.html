<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>D&D Player Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="mobile-web-app-capable" content="yes" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/react@17/umd/react.development.js" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@17/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Cinzel', serif;
      background: #f4e4bc url("https://www.transparenttextures.com/patterns/aged-paper.png") repeat;
      background-blend-mode: overlay;
      color: #4a2c0f;
    }
    .dark {
      background-color: #1a1a1a;
      color: #fafafa;
      background-blend-mode: normal;
    }
    .app-container {
      background-color: #1a222e;
      border-radius: 0.5rem;
      color: #f4e4bc;
    }
    input, select, textarea {
      font-family: 'Cinzel', serif;
      color: #000000 !important;
      background-color: #f9efd4 !important;
      border-color: #4a3f35 !important;
    }
    input::placeholder, textarea::placeholder {
      color: #666666;
    }
    .btn-dnd {
      background-color: #8B0000;
      color: #f4e4bc;
      font-family: 'Cinzel', serif;
      font-weight: bold;
      border: 1px solid #4a3f35;
      transition: all 0.3s ease;
    }
    .btn-dnd:hover {
      background-color: #6d0101;
    }
    .dnd-table {
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
    }
    .dnd-table th {
      background-color: #2c1a0f;
      color: #f4e4bc;
      font-weight: bold;
      padding: 8px;
      text-align: left;
      border: 1px solid #4a3f35;
    }
    .dnd-table td {
      padding: 8px;
      border: 1px solid #4a3f35;
      background-color: #1e2a38;
    }
    .dnd-section-title {
      border-bottom: 2px solid #8B0000;
      color: #f4e4bc;
      font-weight: bold;
      margin-bottom: 0.75rem;
      padding-bottom: 0.25rem;
    }
    .character-card, .enemy-card {
      background-color: #1e2a38;
      color: #f4e4bc;
      border: 1px solid #4a3f35;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }
    .health-bar {
      background-color: #2c1a0f;
      height: 1rem;
      border-radius: 0.25rem;
      overflow: hidden;
    }
    .health-bar-fill {
      height: 100%;
      background-color: #8B0000;
      transition: width 0.3s ease;
    }
    .status-tag {
      background-color: #442200;
      color: #f4e4bc;
      border-radius: 0.25rem;
      padding: 0.25rem 0.5rem;
      margin-right: 0.25rem;
      margin-bottom: 0.25rem;
      display: inline-block;
    }
    .divider {
      border-color: #4a3f35;
      margin: 1rem 0;
    }
    .collapsible-content {
      overflow: hidden;
      transition: max-height 0.3s ease-in-out;
    }
    .party-token {
      background: radial-gradient(circle, #4169E1, #191970);
      border: 2px solid #00BFFF;
    }
    .enemy-token {
      background: radial-gradient(circle, #B22222, #8B0000);
      border: 2px solid #FF4500;
    }
    .neutral-token {
      background: radial-gradient(circle, #DAA520, #B8860B);
      border: 2px solid #FFD700;
    }
    ::-webkit-scrollbar {
      width: 12px;
    }
    ::-webkit-scrollbar-track {
      background: #f5e8c7;
    }
    ::-webkit-scrollbar-thumb {
      background-color: #8b5a2b;
      border-radius: 20px;
      border: 3px solid #f5e8c7;
    }
  </style>
</head>
<body class="text-gray-800">
  <div id="root" class="p-4"></div>

  <script type="text/babel">
    /** LocalStorage Backup/Restore */
    function backupLocalStorage() {
      const data = {
        characters: localStorage.getItem("characters"),
        enemies: localStorage.getItem("enemies"),
        statRows: localStorage.getItem("statRows"),
        mapImage: localStorage.getItem("mapImage"),
        dotPositions: localStorage.getItem("dotPositions"),
        collapsedCharacters: localStorage.getItem("collapsedCharacters"),
        collapsedEnemies: localStorage.getItem("collapsedEnemies"),
        darkMode: localStorage.getItem("darkMode"),
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "dnd_tracker_backup.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    function restoreLocalStorage(event) {
      const files = event.target.files;
      if (!files || !files.length) return;
      const file = files[0];
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          for (const key in data) {
            if (data[key] !== null && data[key] !== undefined) {
              localStorage.setItem(key, data[key]);
            }
          }
          alert("LocalStorage restored. Please refresh the page.");
        } catch (err) {
          console.error(err);
          alert("Failed to restore. Invalid JSON?");
        }
      };
      reader.readAsText(file);
    }

    /** Copy for Prompt */
    function copyForPrompt() {
      const content = document.getElementById("root").innerText;
      navigator.clipboard.writeText(content).then(() => {
        alert("Content copied to clipboard!");
      }).catch(() => {
        alert("Failed to copy content.");
      });
    }

    /** Hook for Expand/Collapse */
    function useCollapseState(storageKey) {
      const [collapseState, setCollapseState] = React.useState(() => {
        const saved = localStorage.getItem(storageKey);
        return saved ? JSON.parse(saved) : {};
      });

      function toggleCollapse(id) {
        setCollapseState((prev) => {
          const newVal = { ...prev, [id]: !prev[id] };
          localStorage.setItem(storageKey, JSON.stringify(newVal));
          return newVal;
        });
      }

      return [collapseState, toggleCollapse];
    }

    /** Dark Mode Toggle */
    function DarkModeToggle() {
      const [darkMode, setDarkMode] = React.useState(() => localStorage.getItem("darkMode") === "true");

      React.useEffect(() => {
        if (darkMode) document.body.classList.add("dark");
        else document.body.classList.remove("dark");
        localStorage.setItem("darkMode", darkMode);
      }, [darkMode]);

      return (
        <button className="px-3 py-1 btn-dnd rounded" onClick={() => setDarkMode(!darkMode)}>
          {darkMode ? "Light Mode" : "Dark Mode"}
        </button>
      );
    }

    /** CharacterCard (with Background/Bio and Image) */
    function CharacterCard({
      char,
      collapsed,
      onToggleCollapse,
      onUpdateChar,
      onHeal,
      onDamage,
      onRemoveStatus,
      onRemoveEffect,
      onRemoveItem,
      onRemoveAbility,
      onRemoveSpell,
      onRemoveChar,
    }) {
      const [isEditing, setIsEditing] = React.useState(false);
      const [editName, setEditName] = React.useState(char.name);
      const [editClass, setEditClass] = React.useState(char.class);
      const [editMaxHealth, setEditMaxHealth] = React.useState(String(char.maxHealth));
      const [editLevel, setEditLevel] = React.useState(String(char.level || 1));
      const [editXP, setEditXP] = React.useState(String(char.xp || 0));
      const [editInitiative, setEditInitiative] = React.useState(String(char.initiative || 0));
      const [editArmorClass, setEditArmorClass] = React.useState(String(char.armorClass || 10));
      const [editEquippedWeapon, setEditEquippedWeapon] = React.useState(char.equippedWeapon || "None");
      const [editNotes, setEditNotes] = React.useState(char.notes || "");
      const [newStatus, setNewStatus] = React.useState("");
      const [newEffect, setNewEffect] = React.useState("");
      const [newItem, setNewItem] = React.useState("");
      const [newAbility, setNewAbility] = React.useState("");
      const [newCantrip, setNewCantrip] = React.useState("");
      const [newSpell, setNewSpell] = React.useState("");
      const [healInput, setHealInput] = React.useState("0");
      const [dmgInput, setDmgInput] = React.useState("0");

      // Ensure cantrips is initialized
      const cantrips = Array.isArray(char.cantrips) ? char.cantrips : [];

      React.useEffect(() => {
        setEditName(char.name);
        setEditClass(char.class);
        setEditMaxHealth(String(char.maxHealth));
        setEditLevel(String(char.level || 1));
        setEditXP(String(char.xp || 0));
        setEditInitiative(String(char.initiative || 0));
        setEditArmorClass(String(char.armorClass || 10));
        setEditEquippedWeapon(char.equippedWeapon || "None");
        setEditNotes(char.notes || "");
      }, [char]);

      function handleImageUpload(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (evt) => onUpdateChar({ ...char, image: evt.target.result });
          reader.readAsDataURL(file);
        }
      }

      function handleSave() {
        const parsedMax = parseInt(editMaxHealth, 10) || 0;
        const clippedHealth = Math.min(char.health, parsedMax);
        onUpdateChar({
          ...char,
          name: editName,
          class: editClass,
          maxHealth: parsedMax,
          health: clippedHealth,
          level: parseInt(editLevel, 10) || 1,
          xp: parseInt(editXP, 10) || 0,
          initiative: parseInt(editInitiative, 10) || 0,
          armorClass: parseInt(editArmorClass, 10) || 10,
          equippedWeapon: editEquippedWeapon,
          notes: editNotes,
          cantrips: cantrips, // Ensure cantrips is passed through
        });
        setIsEditing(false);
      }

      function handleAddStatus() {
        if (!newStatus.trim()) return;
        onUpdateChar({ ...char, status: [...char.status, newStatus.trim()] });
        setNewStatus("");
      }

      function handleAddEffect() {
        if (!newEffect.trim()) return;
        onUpdateChar({ ...char, effects: [...char.effects, newEffect.trim()] });
        setNewEffect("");
      }

      function handleAddItem() {
        if (!newItem.trim()) return;
        onUpdateChar({ ...char, inventory: [...char.inventory, newItem.trim()] });
        setNewItem("");
      }

      function handleAddAbility() {
        if (!newAbility.trim()) return;
        onUpdateChar({ ...char, specialAbilities: [...char.specialAbilities, newAbility.trim()] });
        setNewAbility("");
      }

      function handleAddCantrip() {
        if (!newCantrip.trim()) return;
        onUpdateChar({ ...char, cantrips: [...cantrips, newCantrip.trim()] });
        setNewCantrip("");
      }

      function handleAddSpell() {
        if (!newSpell.trim()) return;
        onUpdateChar({ ...char, spellsMagic: [...char.spellsMagic, newSpell.trim()] });
        setNewSpell("");
      }

      function applyHeal() {
        onHeal(char.id, parseInt(healInput, 10) || 0);
      }

      function applyDamage() {
        onDamage(char.id, parseInt(dmgInput, 10) || 0);
      }

      function toggleDeathSaveSuccess() {
        if (char.deathSaves.success < 3) {
          onUpdateChar({ ...char, deathSaves: { ...char.deathSaves, success: char.deathSaves.success + 1 } });
        }
      }

      function toggleDeathSaveFail() {
        if (char.deathSaves.fail < 3) {
          onUpdateChar({ ...char, deathSaves: { ...char.deathSaves, fail: char.deathSaves.fail + 1 } });
        }
      }

      function resetDeathSaves() {
        onUpdateChar({ ...char, deathSaves: { success: 0, fail: 0 } });
      }

      const mainContentStyle = collapsed ? { maxHeight: 0, overflow: 'hidden' } : { maxHeight: "9999px" };

      if (isEditing) {
        return (
          <div className="character-card p-4 rounded-lg shadow space-y-2 mb-4">
            <div className="flex justify-between items-center">
              <h3 className="font-bold text-amber-400">Editing {char.name}</h3>
              <button className="px-2 py-1 btn-dnd rounded" onClick={() => onRemoveChar(char.id)}>Remove</button>
            </div>
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
              <div>
                <label htmlFor={`edit-name-${char.id}`} className="block text-sm font-medium text-amber-400 mb-1">Character Name</label>
                <input id={`edit-name-${char.id}`} className="border p-1 rounded w-full" value={editName} onChange={(e) => setEditName(e.target.value)} />
              </div>
              <div>
                <label htmlFor={`edit-class-${char.id}`} className="block text-sm font-medium text-amber-400 mb-1">Class/Race</label>
                <input id={`edit-class-${char.id}`} className="border p-1 rounded w-full" value={editClass} onChange={(e) => setEditClass(e.target.value)} placeholder="Fighter/Human" />
              </div>
              <div>
                <label htmlFor={`edit-maxhealth-${char.id}`} className="block text-sm font-medium text-amber-400 mb-1">Max Health</label>
                <input id={`edit-maxhealth-${char.id}`} type="number" className="border p-1 rounded w-full" value={editMaxHealth} onChange={(e) => setEditMaxHealth(e.target.value)} />
              </div>
              <div>
                <label htmlFor={`edit-level-${char.id}`} className="block text-sm font-medium text-amber-400 mb-1">Level</label>
                <input id={`edit-level-${char.id}`} type="number" className="border p-1 rounded w-full" value={editLevel} onChange={(e) => setEditLevel(e.target.value)} />
              </div>
              <div>
                <label htmlFor={`edit-xp-${char.id}`} className="block text-sm font-medium text-amber-400 mb-1">Experience Points</label>
                <input id={`edit-xp-${char.id}`} type="number" className="border p-1 rounded w-full" value={editXP} onChange={(e) => setEditXP(e.target.value)} />
              </div>
              <div>
                <label htmlFor={`edit-initiative-${char.id}`} className="block text-sm font-medium text-amber-400 mb-1">Initiative Bonus</label>
                <input id={`edit-initiative-${char.id}`} type="number" className="border p-1 rounded w-full" value={editInitiative} onChange={(e) => setEditInitiative(e.target.value)} />
              </div>
            </div>
            
            <div>
              <div>
                <label htmlFor={`edit-armorclass-${char.id}`} className="block text-sm font-medium text-amber-400 mb-1">Armor Class</label>
                <input id={`edit-armorclass-${char.id}`} type="number" className="border p-1 rounded w-full" value={editArmorClass} onChange={(e) => setEditArmorClass(e.target.value)} />
              </div>
              <div>
                <label htmlFor={`edit-weapon-${char.id}`} className="block text-sm font-medium text-amber-400 mb-1">Equipped Weapon/Item</label>
                <input id={`edit-weapon-${char.id}`} className="border p-1 rounded w-full" value={editEquippedWeapon} onChange={(e) => setEditEquippedWeapon(e.target.value)} />
              </div>
            </div>
            
            <div>
              <label htmlFor={`edit-notes-${char.id}`} className="block text-sm font-medium text-amber-400 mb-1">Character Notes/Bio</label>
              <textarea id={`edit-notes-${char.id}`} className="border p-1 rounded w-full" rows={3} value={editNotes} onChange={(e) => setEditNotes(e.target.value)} />
            </div>
            
            <div className="flex gap-2 mt-4">
              <button className="px-3 py-1 btn-dnd rounded" onClick={handleSave}>Save</button>
              <button className="px-2 py-1 bg-gray-700 text-f4e4bc rounded" onClick={() => setIsEditing(false)}>Cancel</button>
            </div>
          </div>
        );
      }

      return (
        <div className={`character-card p-4 rounded-lg shadow mb-4 ${collapsed ? "collapsed" : ""}`}>
          <div className="flex justify-between items-center">
            <div className="flex items-center gap-2">
              <button onClick={() => onToggleCollapse(char.id)} className="collapse-button text-sm font-bold text-amber-400">
                {collapsed ? "▶ " : "▼ "}{char.name}
              </button>
              <span className="text-sm">({char.class})</span>
            </div>
            <div className="flex items-center gap-2">
              <span className="text-sm">Init: {char.initiative || 0} | Lvl: {char.level || 1}</span>
              <button className="px-2 py-1 bg-amber-700 text-white rounded hover:bg-amber-800 text-sm" onClick={() => setIsEditing(true)}>Edit</button>
              <button className="px-2 py-1 btn-dnd rounded text-sm" onClick={() => onRemoveChar(char.id)}>Remove</button>
            </div>
          </div>

          <div className="collapsible-content transition-all duration-300 ease-in-out" style={mainContentStyle}>
            {!collapsed && (
              <div>
                <div className="flex justify-between items-center mb-2">
                  <div className="text-sm mb-1 mt-2">XP: {char.xp || 0}</div>
                  <div className="text-sm">Armor Class: {char.armorClass || 10}</div>
                </div>
                
                <div className="mb-2">
                  <div className="text-sm font-medium text-amber-400">Equipped: {char.equippedWeapon || "None"}</div>
                </div>
                
                <label className="block text-sm font-medium text-amber-400">Character Image</label>
                <div className="flex items-center gap-2 mt-1">
                  {char.image ? (
                    <img src={char.image} alt={char.name} className="w-12 h-12 object-cover rounded-full" />
                  ) : (
                    <div className="w-12 h-12 bg-gray-700 rounded-full flex items-center justify-center">
                      <span className="text-gray-400 text-xs">No Img</span>
                    </div>
                  )}
                  <input type="file" accept="image/*" onChange={handleImageUpload} className="mt-1 text-sm" id={`image-upload-${char.id}`} />
                  {char.image && (
                    <button className="px-2 py-1 btn-dnd rounded text-sm" onClick={() => onUpdateChar({ ...char, image: null })}>
                      Remove Image
                    </button>
                  )}
                </div>

                <div className="mt-2">
                  <div className="flex items-center gap-2">
                    <span className="text-red-600 font-bold">♥</span>
                    <div className="health-bar rounded-full w-full">
                      <div 
                        className="health-bar-fill rounded-full" 
                        style={{ width: `${(char.health / char.maxHealth) * 100}%` }}
                      ></div>
                    </div>
                    <span className="text-sm">{char.health}/{char.maxHealth}</span>
                  </div>
                </div>

                <div className="mt-2">
                  <h4 className="font-semibold text-sm text-amber-400">Status Conditions:</h4>
                  <div className="mt-1 flex flex-wrap gap-1">
                    {char.status.map((stat, idx) => (
                      <div key={idx} className="status-tag flex items-center justify-between">
                        {stat}
                        <button className="ml-2 text-red-400 hover:text-red-600" onClick={() => onRemoveStatus(char.id, idx)}>×</button>
                      </div>
                    ))}
                    {char.status.length === 0 && <span className="text-gray-500 text-sm">None</span>}
                  </div>
                  <div className="flex gap-2 mt-1">
                    <input id={`new-status-${char.id}`} className="border p-1 rounded text-sm" value={newStatus} onChange={(e) => setNewStatus(e.target.value)} placeholder="Add status" />
                    <button className="px-2 py-1 btn-dnd rounded text-sm" onClick={handleAddStatus}>Add</button>
                  </div>
                </div>

                <div className="mt-2">
                  <h4 className="font-semibold text-sm text-amber-400">Effects:</h4>
                  <div className="mt-1 flex flex-wrap gap-1">
                    {char.effects.map((eff, idx) => (
                      <div key={idx} className="status-tag flex items-center justify-between">
                        {eff}
                        <button className="ml-2 text-red-400 hover:text-red-600" onClick={() => onRemoveEffect(char.id, idx)}>×</button>
                      </div>
                    ))}
                    {char.effects.length === 0 && <span className="text-gray-500 text-sm">None</span>}
                  </div>
                  <div className="flex gap-2 mt-1">
                    <input id={`new-effect-${char.id}`} className="border p-1 rounded text-sm" value={newEffect} onChange={(e) => setNewEffect(e.target.value)} placeholder="Add effect" />
                    <button className="px-2 py-1 btn-dnd rounded text-sm" onClick={handleAddEffect}>Add</button>
                  </div>
                </div>

                <div className="mt-2">
                  <h4 className="font-semibold text-sm text-amber-400">Inventory:</h4>
                  <div className="mt-1 flex flex-wrap gap-1">
                    {char.inventory.map((item, idx) => (
                      <div key={idx} className="status-tag flex items-center justify-between">
                        {item}
                        <button className="ml-2 text-red-400 hover:text-red-600" onClick={() => onRemoveItem(char.id, idx)}>×</button>
                      </div>
                    ))}
                    {char.inventory.length === 0 && <span className="text-gray-500 text-sm">Empty</span>}
                  </div>
                  <div className="flex gap-2 mt-1">
                    <input id={`new-item-${char.id}`} className="border p-1 rounded text-sm" value={newItem} onChange={(e) => setNewItem(e.target.value)} placeholder="New item" />
                    <button className="px-2 py-1 btn-dnd rounded text-sm" onClick={handleAddItem}>Add</button>
                  </div>
                </div>

                <div className="mt-2">
                  <h4 className="font-semibold text-sm text-amber-400">Cantrips/Basic Skills:</h4>
                  <div className="mt-1 flex flex-wrap gap-1">
                    {cantrips.map((cantrip, idx) => (
                      <div key={idx} className="status-tag flex items-center justify-between">
                        {cantrip}
                        <button 
                          className="ml-2 text-red-400 hover:text-red-600" 
                          onClick={() => {
                            const updatedCantrips = [...cantrips];
                            updatedCantrips.splice(idx, 1);
                            onUpdateChar({ ...char, cantrips: updatedCantrips });
                          }}
                        >
                          ×
                        </button>
                      </div>
                    ))}
                    {cantrips.length === 0 && <span className="text-gray-500 text-sm">None</span>}
                  </div>
                  <div className="flex gap-2 mt-1">
                    <input 
                      id={`new-cantrip-${char.id}`} 
                      className="border p-1 rounded text-sm" 
                      value={newCantrip} 
                      onChange={(e) => setNewCantrip(e.target.value)} 
                      placeholder="Add cantrip/skill" 
                    />
                    <button className="px-2 py-1 btn-dnd rounded text-sm" onClick={handleAddCantrip}>Add</button>
                  </div>
                </div>

                <div className="mt-2">
                  <h4 className="font-semibold text-sm text-amber-400">Special Abilities:</h4>
                  <div className="mt-1 flex flex-wrap gap-1">
                    {char.specialAbilities.map((ability, idx) => (
                      <div key={idx} className="status-tag flex items-center justify-between">
                        {ability}
                        <button className="ml-2 text-red-400 hover:text-red-600" onClick={() => onRemoveAbility(char.id, idx)}>×</button>
                      </div>
                    ))}
                    {char.specialAbilities.length === 0 && <span className="text-gray-500 text-sm">None</span>}
                  </div>
                  <div className="flex gap-2 mt-1">
                    <input id={`new-ability-${char.id}`} className="border p-1 rounded text-sm" value={newAbility} onChange={(e) => setNewAbility(e.target.value)} placeholder="Add ability" />
                    <button className="px-2 py-1 btn-dnd rounded text-sm" onClick={handleAddAbility}>Add</button>
                  </div>
                </div>

                <div className="mt-2">
                  <h4 className="font-semibold text-sm text-amber-400">Spells/Magic:</h4>
                  <div className="mt-1 flex flex-wrap gap-1">
                    {char.spellsMagic.map((spell, idx) => (
                      <div key={idx} className="status-tag flex items-center justify-between">
                        {spell}
                        <button className="ml-2 text-red-400 hover:text-red-600" onClick={() => onRemoveSpell(char.id, idx)}>×</button>
                      </div>
                    ))}
                    {char.spellsMagic.length === 0 && <span className="text-gray-500 text-sm">None</span>}
                  </div>
                  <div className="flex gap-2 mt-1">
                    <input id={`new-spell-${char.id}`} className="border p-1 rounded text-sm" value={newSpell} onChange={(e) => setNewSpell(e.target.value)} placeholder="Add spell" />
                    <button className="px-2 py-1 btn-dnd rounded text-sm" onClick={handleAddSpell}>Add</button>
                  </div>
                </div>

                <div className="mt-4 flex gap-4 flex-wrap">
                  <div>
                    <label className="text-sm block text-amber-400">Heal #</label>
                    <div className="flex items-center gap-2">
                      <input id={`heal-input-${char.id}`} type="number" className="w-16 border rounded p-1 text-sm" value={healInput} onChange={(e) => setHealInput(e.target.value)} />
                      <button className="px-3 py-1 bg-green-700 text-white rounded hover:bg-green-800 text-sm" onClick={applyHeal}>Heal</button>
                    </div>
                  </div>
                  <div>
                    <label className="text-sm block text-amber-400">Damage #</label>
                    <div className="flex items-center gap-2">
                      <input id={`dmg-input-${char.id}`} type="number" className="w-16 border rounded p-1 text-sm" value={dmgInput} onChange={(e) => setDmgInput(e.target.value)} />
                      <button className="px-3 py-1 btn-dnd rounded text-sm" onClick={applyDamage}>Damage</button>
                    </div>
                  </div>
                </div>

                {char.health <= 0 && (
                  <div className="mt-4 p-2 bg-gray-800 rounded">
                    <h4 className="font-semibold text-sm text-amber-400">Death Saves</h4>
                    <p className="text-xs">Successes: {char.deathSaves.success} / Failures: {char.deathSaves.fail}</p>
                    <div className="flex gap-2 mt-1">
                      <button className="px-2 py-1 bg-green-700 text-white rounded hover:bg-green-800 text-sm" onClick={toggleDeathSaveSuccess} disabled={char.deathSaves.success >= 3}>
                        + Success
                      </button>
                      <button className="px-2 py-1 btn-dnd rounded text-sm" onClick={toggleDeathSaveFail} disabled={char.deathSaves.fail >= 3}>
                        + Fail
                      </button>
                      <button className="px-2 py-1 bg-gray-700 text-white rounded hover:bg-gray-600 text-sm" onClick={resetDeathSaves}>Reset</button>
                    </div>
                  </div>
                )}

                {char.notes && (
                  <div className="mt-4">
                    <h4 className="font-semibold text-sm text-amber-400">Notes/Bio:</h4>
                    <p className="text-sm whitespace-pre-line">{char.notes}</p>
                  </div>
                )}
              </div>
            )}
          </div>
        </div>
      );
    }

    /** EnemyCard */
    function EnemyCard({ enemy, collapsed, onToggleCollapse, onHealEnemy, onDamageEnemy, onRemoveEnemy, onUpdateEnemy }) {
      const [isEditing, setIsEditing] = React.useState(false);
      const [editName, setEditName] = React.useState(enemy.name);
      const [editMaxHealth, setEditMaxHealth] = React.useState(String(enemy.maxHealth));
      const [editHealth, setEditHealth] = React.useState(String(enemy.health));
      const [healInput, setHealInput] = React.useState("0");
      const [dmgInput, setDmgInput] = React.useState("0");

      React.useEffect(() => {
        setEditName(enemy.name);
        setEditMaxHealth(String(enemy.maxHealth));
        setEditHealth(String(enemy.health));
      }, [enemy]);

      function handleSave() {
        const parsedMax = parseInt(editMaxHealth, 10) || 0;
        const parsedHealth = parseInt(editHealth, 10) || 0;
        const clippedHealth = Math.min(parsedHealth, parsedMax);
        onUpdateEnemy({ ...enemy, name: editName, maxHealth: parsedMax, health: clippedHealth });
        setIsEditing(false);
      }

      function applyHeal() {
        onHealEnemy(enemy.id, parseInt(healInput, 10) || 0);
      }

      function applyDamage() {
        onDamageEnemy(enemy.id, parseInt(dmgInput, 10) || 0);
      }

      const mainContentStyle = collapsed ? { maxHeight: 0, overflow: 'hidden' } : { maxHeight: "9999px" };

      if (isEditing) {
        return (
          <div className="enemy-card p-4 rounded-lg shadow space-y-2 mb-4">
            <div className="flex justify-between items-center">
              <h3 className="font-bold text-amber-400">Editing Enemy</h3>
              <button className="px-2 py-1 btn-dnd rounded" onClick={() => onRemoveEnemy(enemy.id)}>Defeat</button>
            </div>
            <div className="flex flex-col gap-2">
              <div>
                <label htmlFor={`edit-enemy-name-${enemy.id}`} className="block text-sm font-medium text-amber-400 mb-1">Enemy Name</label>
                <input id={`edit-enemy-name-${enemy.id}`} className="border p-1 rounded w-full" value={editName} onChange={(e) => setEditName(e.target.value)} />
              </div>
              <div>
                <label htmlFor={`edit-enemy-maxhealth-${enemy.id}`} className="block text-sm font-medium text-amber-400 mb-1">Max Health</label>
                <input id={`edit-enemy-maxhealth-${enemy.id}`} type="number" className="border p-1 rounded w-full" value={editMaxHealth} onChange={(e) => setEditMaxHealth(e.target.value)} />
              </div>
              <div>
                <label htmlFor={`edit-enemy-health-${enemy.id}`} className="block text-sm font-medium text-amber-400 mb-1">Current Health</label>
                <input id={`edit-enemy-health-${enemy.id}`} type="number" className="border p-1 rounded w-full" value={editHealth} onChange={(e) => setEditHealth(e.target.value)} />
              </div>
              <div className="flex gap-2">
                <button className="px-3 py-1 bg-green-700 text-white rounded hover:bg-green-800" onClick={handleSave}>Save</button>
                <button className="px-2 py-1 bg-gray-700 text-white rounded hover:bg-gray-600" onClick={() => setIsEditing(false)}>Cancel</button>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className={`enemy-card p-4 rounded-lg shadow mb-4 ${collapsed ? "collapsed" : ""}`}>
          <div className="flex justify-between items-center">
            <div className="flex items-center gap-2">
              <button onClick={() => onToggleCollapse(enemy.id)} className="collapse-button text-sm font-bold text-amber-400">
                {collapsed ? "▶ " : "▼ "}{enemy.name}
              </button>
            </div>
            <div className="flex gap-2 items-center">
              <button className="px-2 py-1 bg-amber-700 text-white rounded hover:bg-amber-800 text-sm" onClick={() => setIsEditing(true)}>Edit</button>
              <button className="px-2 py-1 btn-dnd rounded text-sm" onClick={() => onRemoveEnemy(enemy.id)}>Defeat</button>
            </div>
          </div>
          <div className="collapsible-content transition-all duration-300 ease-in-out" style={mainContentStyle}>
            {!collapsed && (
              <div>
                <div className="flex items-center gap-2 mt-2">
                  <span className="text-red-600 font-bold">♥</span>
                  <div className="health-bar rounded-full w-full">
                    <div 
                      className="health-bar-fill rounded-full" 
                      style={{ width: `${(enemy.health / enemy.maxHealth) * 100}%` }}
                    ></div>
                  </div>
                  <span className="text-sm">{enemy.health}/{enemy.maxHealth}</span>
                </div>
                <div className="mt-4 flex gap-4 flex-wrap">
                  <div>
                    <label className="text-sm block text-amber-400">Heal #</label>
                    <div className="flex items-center gap-2">
                      <input id={`enemy-heal-input-${enemy.id}`} type="number" className="w-16 border rounded p-1 text-sm" value={healInput} onChange={(e) => setHealInput(e.target.value)} />
                      <button className="px-3 py-1 bg-green-700 text-white rounded hover:bg-green-800 text-sm" onClick={applyHeal}>Heal</button>
                    </div>
                  </div>
                  <div>
                    <label className="text-sm block text-amber-400">Damage #</label>
                    <div className="flex items-center gap-2">
                      <input id={`enemy-dmg-input-${enemy.id}`} type="number" className="w-16 border rounded p-1 text-sm" value={dmgInput} onChange={(e) => setDmgInput(e.target.value)} />
                      <button className="px-3 py-1 btn-dnd rounded text-sm" onClick={applyDamage}>Damage</button>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    /** StatsSection */
    function StatsSection({ statRows, setStatRows }) {
      const [nextId, setNextId] = React.useState(statRows.length ? Math.max(...statRows.map((r) => r.id)) + 1 : 2);

      function addStatRow() {
        setStatRows((prev) => [
          ...prev,
          { id: nextId, label: `Character #${nextId}`, str: 10, dex: 10, con: 10, int: 10, wis: 10, cha: 10 },
        ]);
        setNextId(nextId + 1);
      }

      function removeStatRow(rowId) {
        setStatRows((prev) => prev.filter((row) => row.id !== rowId));
      }

      function updateStatRow(rowId, updated) {
        setStatRows((prev) => prev.map((row) => (row.id === rowId ? updated : row)));
      }

      function clampScore(val) {
        if (val < 6) return 6;
        if (val > 20) return 20;
        return val;
      }

      function computeMod(score) {
        const mod = Math.floor((score - 10) / 2);
        return mod >= 0 ? "+" + mod : "" + mod;
      }

      return (
        <div className="character-card p-4 rounded-lg mb-4">
          <div className="flex justify-between items-center mb-2">
            <h2 className="text-xl font-bold text-amber-400">Stat Calculator</h2>
            <button className="px-2 py-1 btn-dnd rounded" onClick={addStatRow}>Add Stat Row</button>
          </div>
          <p className="text-sm mb-4">Enter scores (6–20) to see modifiers.</p>
          <div className="max-h-96 overflow-y-auto">
            {statRows.map((row) => {
              const modSTR = computeMod(row.str);
              const modDEX = computeMod(row.dex);
              const modCON = computeMod(row.con);
              const modINT = computeMod(row.int);
              const modWIS = computeMod(row.wis);
              const modCHA = computeMod(row.cha);

              return (
                <div key={row.id} className="bg-gray-800 p-4 rounded shadow mb-4 space-y-2">
                  <div className="flex justify-between items-center">
                    <input
                      id={`stat-label-${row.id}`}
                      className="border rounded p-1 text-sm"
                      value={row.label}
                      onChange={(e) => updateStatRow(row.id, { ...row, label: e.target.value })}
                    />
                    <button className="px-2 py-1 btn-dnd rounded text-sm" onClick={() => removeStatRow(row.id)}>Remove</button>
                  </div>
                  <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-2 mt-2">
                    <div className="flex flex-col">
                      <label className="font-semibold text-xs text-amber-400">STR</label>
                      <input
                        id={`stat-str-${row.id}`}
                        type="number"
                        className="border p-1 rounded text-sm"
                        value={row.str}
                        onChange={(e) => {
                          const val = clampScore(parseInt(e.target.value) || 10);
                          updateStatRow(row.id, { ...row, str: val });
                        }}
                      />
                      <span className="text-center text-blue-400 text-xs mt-1">{modSTR}</span>
                    </div>
                    <div className="flex flex-col">
                      <label className="font-semibold text-xs text-amber-400">DEX</label>
                      <input
                        id={`stat-dex-${row.id}`}
                        type="number"
                        className="border p-1 rounded text-sm"
                        value={row.dex}
                        onChange={(e) => {
                          const val = clampScore(parseInt(e.target.value) || 10);
                          updateStatRow(row.id, { ...row, dex: val });
                        }}
                      />
                      <span className="text-center text-blue-400 text-xs mt-1">{modDEX}</span>
                    </div>
                    <div className="flex flex-col">
                      <label className="font-semibold text-xs text-amber-400">CON</label>
                      <input
                        id={`stat-con-${row.id}`}
                        type="number"
                        className="border p-1 rounded text-sm"
                        value={row.con}
                        onChange={(e) => {
                          const val = clampScore(parseInt(e.target.value) || 10);
                          updateStatRow(row.id, { ...row, con: val });
                        }}
                      />
                      <span className="text-center text-blue-400 text-xs mt-1">{modCON}</span>
                    </div>
                    <div className="flex flex-col">
                      <label className="font-semibold text-xs text-amber-400">INT</label>
                      <input
                        id={`stat-int-${row.id}`}
                        type="number"
                        className="border p-1 rounded text-sm"
                        value={row.int}
                        onChange={(e) => {
                          const val = clampScore(parseInt(e.target.value) || 10);
                          updateStatRow(row.id, { ...row, int: val });
                        }}
                      />
                      <span className="text-center text-blue-400 text-xs mt-1">{modINT}</span>
                    </div>
                    <div className="flex flex-col">
                      <label className="font-semibold text-xs text-amber-400">WIS</label>
                      <input
                        id={`stat-wis-${row.id}`}
                        type="number"
                        className="border p-1 rounded text-sm"
                        value={row.wis}
                        onChange={(e) => {
                          const val = clampScore(parseInt(e.target.value) || 10);
                          updateStatRow(row.id, { ...row, wis: val });
                        }}
                      />
                      <span className="text-center text-blue-400 text-xs mt-1">{modWIS}</span>
                    </div>
                    <div className="flex flex-col">
                      <label className="font-semibold text-xs text-amber-400">CHA</label>
                      <input
                        id={`stat-cha-${row.id}`}
                        type="number"
                        className="border p-1 rounded text-sm"
                        value={row.cha}
                        onChange={(e) => {
                          const val = clampScore(parseInt(e.target.value) || 10);
                          updateStatRow(row.id, { ...row, cha: val });
                        }}
                      />
                      <span className="text-center text-blue-400 text-xs mt-1">{modCHA}</span>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      );
    }

    /** MapSection (Fixed to display as rectangle) */
    function MapSection({ mapImage, setMapImage, dotPositions, setDotPositions }) {
      const [isDragging, setIsDragging] = React.useState(null);
      const mapRef = React.useRef(null);

      function handleImageUpload(event) {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            setMapImage(e.target.result);
            
            // Set default dot positions if none exist
            if (!dotPositions.length) {
              setDotPositions([
                { x: 20, y: 20, color: "red", label: "Player 1" },
                { x: 40, y: 40, color: "blue", label: "Player 2" },
                { x: 60, y: 60, color: "green", label: "Player 3" },
                { x: 80, y: 80, color: "purple", label: "Player 4" },
                { x: 25, y: 30, color: "orange", label: "Enemy 1" },
                { x: 45, y: 50, color: "yellow", label: "Enemy 2" },
                { x: 65, y: 70, color: "pink", label: "Enemy 3" },
                { x: 85, y: 90, color: "cyan", label: "Enemy 4" }
              ]);
            }
          };
          reader.readAsDataURL(file);
        }
      }

      function handleDeleteImage() {
        setMapImage(null);
        setDotPositions([]);
      }

      function handleMouseDown(index) {
        return (e) => {
          e.preventDefault();
          setIsDragging(index);
        };
      }

      function handleMouseMove(e) {
        if (isDragging !== null && mapRef.current) {
          const rect = mapRef.current.getBoundingClientRect();
          const x = ((e.clientX - rect.left) / rect.width) * 100;
          const y = ((e.clientY - rect.top) / rect.height) * 100;
          setDotPositions((prev) =>
            prev.map((dot, i) =>
              i === isDragging ? { ...dot, x: Math.max(0, Math.min(100, x)), y: Math.max(0, Math.min(100, y)) } : dot
            )
          );
        }
      }

      function handleMouseUp() {
        setIsDragging(null);
      }

      function handleTouchStart(index) {
        return (e) => {
          e.preventDefault();
          setIsDragging(index);
        };
      }

      function handleTouchMove(e) {
        if (isDragging !== null && mapRef.current) {
          const touch = e.touches[0];
          const rect = mapRef.current.getBoundingClientRect();
          const x = ((touch.clientX - rect.left) / rect.width) * 100;
          const y = ((touch.clientY - rect.top) / rect.height) * 100;
          setDotPositions((prev) =>
            prev.map((dot, i) =>
              i === isDragging ? { ...dot, x: Math.max(0, Math.min(100, x)), y: Math.max(0, Math.min(100, y)) } : dot
            )
          );
        }
      }

      function handleTouchEnd() {
        setIsDragging(null);
      }

      return (
        <div className="character-card p-4 rounded-lg mb-4">
          <h2 className="text-xl font-bold text-amber-400 mb-2">Party & Enemy Location Map</h2>
          {mapImage ? (
            <div className="relative">
              <div
                ref={mapRef}
                className="relative cursor-pointer"
                onMouseMove={handleMouseMove}
                onMouseUp={handleMouseUp}
                onMouseLeave={handleMouseUp}
                onTouchMove={handleTouchMove}
                onTouchEnd={handleTouchEnd}
              >
                <img src={mapImage} alt="Map" className="w-full rounded" />
                {dotPositions.map((dot, index) => (
                  <div
                    key={index}
                    className="absolute"
                    style={{
                      left: `${dot.x}%`,
                      top: `${dot.y}%`,
                      transform: "translate(-50%, -50%)",
                      cursor: "grab",
                      zIndex: 10
                    }}
                  >
                    <div
                      className="w-5 h-5 rounded-full flex items-center justify-center"
                      style={{
                        backgroundColor: dot.color,
                        boxShadow: "0 0 6px rgba(0,0,0,0.8)"
                      }}
                      onMouseDown={handleMouseDown(index)}
                      onTouchStart={handleTouchStart(index)}
                    ></div>
                    <div className="absolute top-5 left-1/2 transform -translate-x-1/2 text-xs font-bold bg-black bg-opacity-75 text-white px-1 py-0.5 rounded whitespace-nowrap" style={{ zIndex: 20 }}>
                      {dot.label}
                    </div>
                  </div>
                ))}
              </div>
              <div className="mt-2">
                <div className="text-sm mb-2 flex flex-wrap gap-2">
                  <span className="flex items-center">
                    <span className="inline-block w-3 h-3 rounded-full bg-red-500 mr-1"></span> Player 1
                  </span>
                  <span className="flex items-center">
                    <span className="inline-block w-3 h-3 rounded-full bg-blue-500 mr-1"></span> Player 2
                  </span>
                  <span className="flex items-center">
                    <span className="inline-block w-3 h-3 rounded-full bg-green-500 mr-1"></span> Player 3
                  </span>
                  <span className="flex items-center">
                    <span className="inline-block w-3 h-3 rounded-full bg-purple-500 mr-1"></span> Player 4
                  </span>
                  <span className="flex items-center">
                    <span className="inline-block w-3 h-3 rounded-full bg-orange-500 mr-1"></span> Enemy 1
                  </span>
                  <span className="flex items-center">
                    <span className="inline-block w-3 h-3 rounded-full bg-yellow-500 mr-1"></span> Enemy 2
                  </span>
                  <span className="flex items-center">
                    <span className="inline-block w-3 h-3 rounded-full bg-pink-500 mr-1"></span> Enemy 3
                  </span>
                  <span className="flex items-center">
                    <span className="inline-block w-3 h-3 rounded-full bg-cyan-500 mr-1"></span> Enemy 4
                  </span>
                </div>
                <div className="flex gap-2">
                  <label className="px-3 py-1 btn-dnd rounded text-sm cursor-pointer">
                    Choose File
                    <input type="file" accept="image/*" onChange={handleImageUpload} className="hidden" id="map-upload" />
                  </label>
                  <button className="px-3 py-1 btn-dnd rounded text-sm" onClick={handleDeleteImage}>Delete Map</button>
                </div>
              </div>
            </div>
          ) : (
            <div>
              <label className="block text-sm font-medium text-amber-400 mb-1">Upload Map Image</label>
              <label className="px-3 py-1 btn-dnd rounded text-sm cursor-pointer">
                Choose File
                <input type="file" accept="image/*" onChange={handleImageUpload} className="hidden" id="map-upload" />
              </label>
            </div>
          )}
        </div>
      );
    }

    /** PartyImages */
    function PartyImages({ characters }) {
      return (
        <div className="character-card p-4 rounded-lg mb-4">
          <h2 className="text-xl font-bold text-amber-400 mb-2">Party Member Images</h2>
          <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2 max-h-48 overflow-y-auto">
            {characters.map((char) => (
              <div key={char.id} className="text-center">
                {char.image ? (
                  <img src={char.image} alt={char.name} className="w-12 h-12 object-cover rounded-full mx-auto" />
                ) : (
                  <div className="w-12 h-12 bg-gray-700 rounded-full mx-auto flex items-center justify-center">
                    <span className="text-gray-400 text-xs">No Img</span>
                  </div>
                )}
                <p className="mt-1 text-xs truncate">{char.name}</p>
              </div>
            ))}
            {characters.length === 0 && <p className="text-sm col-span-full text-center">No characters added yet</p>}
          </div>
        </div>
      );
    }

    /** CopyButton */
    function CopyButton({ characters, enemies }) {
      function handleCopy() {
        const text = [
          "### Characters",
          ...characters.map((c) => {
            return (
              "Character: " + c.name +
              "\nClass: " + c.class +
              "\nLevel: " + (c.level || 1) +
              "\nXP: " + (c.xp || 0) +
              "\nInitiative: " + (c.initiative || 0) +
              "\nArmor Class: " + (c.armorClass || 10) +
              "\nEquipped: " + (c.equippedWeapon || "None") +
              "\nHealth: " + c.health + "/" + c.maxHealth +
              "\nStatus: " + (c.status.length ? c.status.join(", ") : "None") +
              "\nEffects: " + (c.effects.length ? c.effects.join(", ") : "None") +
              "\nInventory: " + (c.inventory.length ? c.inventory.join(", ") : "None") +
              "\nAbilities: " + (c.specialAbilities.length ? c.specialAbilities.join(", ") : "None") +
              "\nCantrips: " + (Array.isArray(c.cantrips) && c.cantrips.length ? c.cantrips.join(", ") : "None") +
              "\nSpells: " + (c.spellsMagic.length ? c.spellsMagic.join(", ") : "None") +
              "\nNotes: " + (c.notes || "None") +
              "\nImage: " + (c.image ? "Yes" : "No")
            );
          }),
          "",
          "### Enemies",
          ...enemies.map((e) => "Enemy: " + e.name + "\nHealth: " + e.health + "/" + e.maxHealth),
        ].join("\n\n");

        navigator.clipboard.writeText(text)
          .then(() => alert("Character and enemy data copied to clipboard!"))
          .catch((err) => {
            console.error("Failed to copy text: ", err);
            alert("Failed to copy data. Check console for details.");
          });
      }

      return (
        <button className="px-4 py-2 btn-dnd rounded mb-2 text-sm" onClick={handleCopy}>
          Copy for Prompt
        </button>
      );
    }

    /** ClassesSection (Simplified with link) */
    function ClassesSection() {
      return (
        <div className="character-card p-4 rounded-lg mb-4">
          <h2 className="text-xl font-bold text-amber-400 mb-2">D&D 5th Edition Classes</h2>
          <p className="mb-2">
            View all classes and details at: <a href="https://rpgbot.net/dnd5/characters/classes/" target="_blank" rel="noreferrer" className="text-blue-400 hover:underline">RPGBot Classes</a>
          </p>
        </div>
      );
    }

    /** RacesSection (Simplified with link) */
    function RacesSection() {
      return (
        <div className="character-card p-4 rounded-lg mb-4">
          <h2 className="text-xl font-bold text-amber-400 mb-2">D&D 5th Edition Races</h2>
          <p className="mb-2">
            View all races and details at: <a href="https://rpgbot.net/dnd5/characters/races/" target="_blank" rel="noreferrer" className="text-blue-400 hover:underline">RPGBot Races</a>
          </p>
        </div>
      );
    }

    /** MonsterCreatureList (Restored with links) */
    function MonsterCreatureList() {
      return (
        <div className="character-card p-4 rounded-lg mb-4">
          <h2 className="text-xl font-bold text-amber-400 mb-2">Monster/Creature List</h2>
          <p className="mb-2">
            Access a comprehensive database of D&D monsters and creatures at:
          </p>
          <a href="https://www.aidedd.org/dnd-filters/monsters.php" target="_blank" rel="noreferrer" className="text-blue-400 hover:underline">AIDEDD Monster Database</a>
          <p className="mt-2 text-sm">
            Use this resource to find detailed stats and information for monsters in your campaign.
          </p>
        </div>
      );
    }

    /** Note: BulkActions component removed as requested since it's already in the combat tracker */

    /** Main DnDTracker */
    function DnDTracker() {
      const [collapsedCharacters, toggleCharacterCollapse] = useCollapseState("collapsedCharacters");
      const [collapsedEnemies, toggleEnemyCollapse] = useCollapseState("collapsedEnemies");

      const [characters, setCharacters] = React.useState(() => {
        const saved = localStorage.getItem("characters");
        let loaded = saved ? JSON.parse(saved) : [{
          id: 1,
          name: "Jory",
          class: "Cleric/Human",
          health: 100,
          maxHealth: 100,
          armorClass: 15,
          equippedWeapon: "Mace +1",
          status: [],
          effects: [],
          inventory: ["Mace", "Shield"],
          specialAbilities: ["Turn Undead"],
          cantrips: ["Light", "Sacred Flame"],
          spellsMagic: ["Cure Wounds", "Bless"],
          image: null,
          level: 1,
          xp: 0,
          initiative: 0,
          notes: "",
          deathSaves: { success: 0, fail: 0 },
        }];
        // Ensure all characters have the required properties
        return loaded.map((c) => ({
          ...c,
          level: c.level || 1,
          xp: c.xp || 0,
          initiative: c.initiative || 0,
          notes: c.notes || "",
          deathSaves: c.deathSaves || { success: 0, fail: 0 },
          armorClass: c.armorClass || 10,
          equippedWeapon: c.equippedWeapon || "None",
          cantrips: Array.isArray(c.cantrips) ? c.cantrips : []
        }));
      });

      const [enemies, setEnemies] = React.useState(() => {
        const saved = localStorage.getItem("enemies");
        return saved ? JSON.parse(saved) : [];
      });

      const [statRows, setStatRows] = React.useState(() => {
        const saved = localStorage.getItem("statRows");
        return saved ? JSON.parse(saved) : [{ id: 1, label: "Jory", str: 10, dex: 10, con: 10, int: 10, wis: 10, cha: 10 }];
      });

      const [mapImage, setMapImage] = React.useState(() => localStorage.getItem("mapImage") || null);
      const [dotPositions, setDotPositions] = React.useState(() => {
        const saved = localStorage.getItem("dotPositions");
        // Default enemy dots with different colors and labels
        const defaultDots = [
          { x: 20, y: 20, color: "red", label: "Player 1" },
          { x: 40, y: 40, color: "blue", label: "Player 2" },
          { x: 60, y: 60, color: "green", label: "Player 3" },
          { x: 80, y: 80, color: "purple", label: "Player 4" },
          { x: 25, y: 30, color: "orange", label: "Enemy 1" },
          { x: 45, y: 50, color: "yellow", label: "Enemy 2" },
          { x: 65, y: 70, color: "pink", label: "Enemy 3" },
          { x: 85, y: 90, color: "cyan", label: "Enemy 4" }
        ];
        return saved ? JSON.parse(saved) : defaultDots;
      });

      React.useEffect(() => {
        localStorage.setItem("characters", JSON.stringify(characters));
      }, [characters]);
      React.useEffect(() => {
        localStorage.setItem("enemies", JSON.stringify(enemies));
      }, [enemies]);
      React.useEffect(() => {
        localStorage.setItem("statRows", JSON.stringify(statRows));
      }, [statRows]);
      React.useEffect(() => {
        localStorage.setItem("mapImage", mapImage);
        localStorage.setItem("dotPositions", JSON.stringify(dotPositions));
      }, [mapImage, dotPositions]);

      function addCharacter() {
        const newId = Date.now();
        setCharacters((prev) => [
          ...prev,
          {
            id: newId,
            name: "New Character",
            class: "Class/Race",
            health: 50,
            maxHealth: 50,
            armorClass: 10,
            equippedWeapon: "None",
            status: [],
            effects: [],
            inventory: [],
            specialAbilities: [],
            cantrips: [],
            spellsMagic: [],
            image: null,
            level: 1,
            xp: 0,
            initiative: 0,
            notes: "",
            deathSaves: { success: 0, fail: 0 },
          },
        ]);
      }

      function removeCharacter(charId) {
        setCharacters((prev) => prev.filter((c) => c.id !== charId));
      }

      function updateCharacter(updated) {
        setCharacters((prev) => prev.map((c) => (c.id === updated.id ? updated : c)));
      }

      function healCharacter(charId, amt) {
        setCharacters((prev) => prev.map((c) => (c.id === charId ? { ...c, health: Math.min(c.maxHealth, c.health + amt) } : c)));
      }

      function damageCharacter(charId, amt) {
        setCharacters((prev) => prev.map((c) => (c.id === charId ? { ...c, health: Math.max(0, c.health - amt) } : c)));
      }

      function removeStatus(charId, idx) {
        setCharacters((prev) => prev.map((c) => {
          if (c.id === charId) {
            const updated = [...c.status];
            updated.splice(idx, 1);
            return { ...c, status: updated };
          }
          return c;
        }));
      }

      function removeEffect(charId, idx) {
        setCharacters((prev) => prev.map((c) => {
          if (c.id === charId) {
            const updated = [...c.effects];
            updated.splice(idx, 1);
            return { ...c, effects: updated };
          }
          return c;
        }));
      }

      function removeItem(charId, idx) {
        setCharacters((prev) => prev.map((c) => {
          if (c.id === charId) {
            const updated = [...c.inventory];
            updated.splice(idx, 1);
            return { ...c, inventory: updated };
          }
          return c;
        }));
      }

      function removeAbility(charId, idx) {
        setCharacters((prev) => prev.map((c) => {
          if (c.id === charId) {
            const updated = [...c.specialAbilities];
            updated.splice(idx, 1);
            return { ...c, specialAbilities: updated };
          }
          return c;
        }));
      }

      function removeSpell(charId, idx) {
        setCharacters((prev) => prev.map((c) => {
          if (c.id === charId) {
            const updated = [...c.spellsMagic];
            updated.splice(idx, 1);
            return { ...c, spellsMagic: updated };
          }
          return c;
        }));
      }

      function addEnemy() {
        setEnemies((prev) => [
          ...prev,
          { id: Date.now(), name: "Enemy " + (prev.length + 1), health: 50, maxHealth: 50 },
        ]);
      }

      function removeEnemy(enemyId) {
        setEnemies((prev) => prev.filter((e) => e.id !== enemyId));
      }

      function healEnemy(enemyId, amt) {
        setEnemies((prev) => prev.map((e) => (e.id === enemyId ? { ...e, health: Math.min(e.maxHealth, e.health + amt) } : e)));
      }

      function damageEnemy(enemyId, amt) {
        setEnemies((prev) => prev.map((e) => (e.id === enemyId ? { ...e, health: Math.max(0, e.health - amt) } : e)));
      }

      function updateEnemy(updated) {
        setEnemies((prev) => prev.map((e) => (e.id === updated.id ? updated : e)));
      }

      function handleBulkHeal(target, amt) {
        if (target === "characters") {
          setCharacters((prev) => prev.map((c) => ({ ...c, health: Math.min(c.maxHealth, c.health + amt) })));
        } else {
          setEnemies((prev) => prev.map((e) => ({ ...e, health: Math.min(e.maxHealth, e.health + amt) })));
        }
      }

      function handleBulkDamage(target, amt) {
        if (target === "characters") {
          setCharacters((prev) => prev.map((c) => ({ ...c, health: Math.max(0, c.health - amt) })));
        } else {
          setEnemies((prev) => prev.map((e) => ({ ...e, health: Math.max(0, e.health - amt) })));
        }
      }

      return (
        <div className="container mx-auto p-4 space-y-4">
          <div className="flex flex-wrap justify-between items-center mb-4 gap-2">
            <DarkModeToggle />
            <div className="flex gap-2">
              <button className="px-3 py-1 btn-dnd rounded hover:bg-amber-800" onClick={backupLocalStorage}>
                Backup Local Storage
              </button>
              <label className="px-3 py-1 btn-dnd rounded hover:bg-amber-800 cursor-pointer text-sm">
                Restore Data
                <input type="file" accept=".json" onChange={restoreLocalStorage} className="hidden" />
              </label>
            </div>
          </div>

          <div className="mb-4">
            <CopyButton characters={characters} enemies={enemies} />
            <button className="ml-2 px-4 py-2 btn-dnd rounded mb-2 text-sm" onClick={copyForPrompt}>
              Copy All Content
            </button>
          </div>

          <div className="app-container p-4 rounded-lg shadow-md">
            <h2 className="text-xl font-bold mb-2">D&D Character & Party Tracker</h2>
            <div className="mb-6 bg-gray-800 p-3 rounded-lg border border-amber-900">
              <h3 className="text-amber-400 font-bold mb-1">D&D Player Tracker Features:</h3>
              <ol className="list-decimal pl-5 text-sm text-amber-300">
                <li className="mb-1">Track character details including Class/Race combinations</li>
                <li className="mb-1">Manage health, status effects, inventory, and abilities</li>
                <li className="mb-1">Use the interactive map with up to 12 enemy tokens</li>
                <li className="mb-1">Organize character stats with the calculator</li>
                <li className="mb-1">Track enemies and their health separately</li>
                <li className="mb-1">Quick-reference D&D classes and races through external links</li>
                <li className="mb-1">Backup and restore your campaign data</li>
              </ol>
            </div>

            {/* Party Status */}
            <div className="character-card p-4 rounded-lg mb-4">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-xl font-bold text-amber-400">Party Status</h2>
                <button className="px-3 py-1 btn-dnd rounded" onClick={addCharacter}>Add Character</button>
              </div>
              <div className="grid gap-4">
                {characters.map((char) => (
                  <CharacterCard
                    key={char.id}
                    char={char}
                    collapsed={collapsedCharacters[char.id]}
                    onToggleCollapse={toggleCharacterCollapse}
                    onUpdateChar={updateCharacter}
                    onHeal={healCharacter}
                    onDamage={damageCharacter}
                    onRemoveStatus={removeStatus}
                    onRemoveEffect={removeEffect}
                    onRemoveItem={removeItem}
                    onRemoveAbility={removeAbility}
                    onRemoveSpell={removeSpell}
                    onRemoveChar={removeCharacter}
                  />
                ))}
              </div>
            </div>

            <PartyImages characters={characters} />
            <StatsSection statRows={statRows} setStatRows={setStatRows} />

            {/* Enemy Section */}
            <div className="character-card p-4 rounded-lg mb-4">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-xl font-bold text-amber-400">Enemies</h2>
                <button className="px-3 py-1 btn-dnd rounded" onClick={addEnemy}>Add Enemy</button>
              </div>
              <div className="grid gap-4">
                {enemies.map((enemy) => (
                  <EnemyCard
                    key={enemy.id}
                    enemy={enemy}
                    collapsed={collapsedEnemies[enemy.id]}
                    onToggleCollapse={toggleEnemyCollapse}
                    onHealEnemy={healEnemy}
                    onDamageEnemy={damageEnemy}
                    onRemoveEnemy={removeEnemy}
                    onUpdateEnemy={updateEnemy}
                  />
                ))}
                {enemies.length === 0 && <p className="text-center">No enemies added. Click "Add Enemy" to add one.</p>}
              </div>
            </div>

            {/* BulkActions component removed as requested */}
            <MapSection mapImage={mapImage} setMapImage={setMapImage} dotPositions={dotPositions} setDotPositions={setDotPositions} />
            <ClassesSection />
            <RacesSection />
            <MonsterCreatureList />
          </div>
        </div>
      );
    }

    ReactDOM.render(<DnDTracker />, document.getElementById("root"));
  </script>
</body>
</html>
